# 実装計画: 新規アイテムの追加

## 1. 概要

この計画は、ストーリー「新規アイテムの追加」を実現するための実装タスクを定義します。
ユーザーはVS CodeのWebViewに表示されたUIを通じて、新しいエピック、ストーリー、タスクを`story.yaml`に追加できるようになります。

**参照ストーリー:**
- **title:** 新規アイテムの追加
- **as:** ユーザー
- **i want:** VS CodeのWebView上で新しいエピック、ストーリー、タスクを追加したい
- **so that:** YAML形式ストーリーを直接編集することなく、新しいアイテムを追加できるように

## 2. 実装タスク

### Step 1: UIの実装 (WebView)

WebView側に、アイテム追加のトリガーとなるUI要素と、内容を入力するフォームを作成します。

- **タスク 1.1: アイテム追加ボタンの配置**
  - **内容:**
    - 全体を追加する「新規Epic追加」ボタンを配置する。
    - テーブルの各行に、子要素を追加するための「＋」(Story/Task追加)ボタンを配置する。
  - **担当ファイル:** `src/web/App.tsx` (または同等のReactコンポーネント)

- **タスク 1.2: アイテム追加フォームの作成**
  - **内容:**
    - Epic, Story, Taskの追加に必要な情報を入力するための共通フォームコンポーネントを作成する。
    - フォームは選択されたアイテム種別（Epic, Story, Task）に応じて、表示するフィールドを動的に変更する。
    - `title`, `description`, `status` などの共通フィールドと、`points`, `sprint`, 親要素の選択など、アイテム固有のフィールドを実装する。
  - **担当ファイル:** `src/web/components/ItemForm.tsx` (新規作成)

- **タスク 1.3: フォームの入力バリデーション**
  - **内容:**
    - 必須項目（例: `title`）が空でないことを検証する。
    - `points`が整数であることを検証するなど、型に基づいたリアルタイムバリデーションを実装する。
    - 不正な入力があった場合は、エラーメッセージを表示する。
  - **担当ファイル:** `src/web/components/ItemForm.tsx`

### Step 2: 拡張機能バックエンドの実装 (Extension Host)

WebViewから通知された情報をもとに、`story.yaml`ファイルを更新するロジックを拡張機能側に実装します。

- **タスク 2.1: `story.yaml`更新処理の実装**
  - **内容:**
    - WebViewから渡された新しいアイテムのデータを受け取る。
    - `js-yaml`ライブラリを使用して既存の`story.yaml`を読み込み、JavaScriptオブジェクトにパースする。
    - パースしたオブジェクトに新しいアイテムを追加する。
    - 更新したオブジェクトをYAML文字列に変換し、`story.yaml`に書き込む。
  - **担当ファイル:** `src/web/extension.ts`

### Step 3: UIとバックエンドの連携

UIからのアクションをバックエンドに伝え、処理結果をUIに反映させるための仕組みを実装します。

- **タスク 3.1: メッセージングの実装 (WebView -> Extension)**
  - **内容:**
    - ユーザーがフォームで「保存」ボタンをクリックした際に、`vscode.postMessage` を使用してフォームのデータを拡張機能バックエンドに送信する。
    - 送信するメッセージには、追加するアイテムの種類（Epic, Story, Task）、データ本体、および親要素のIDなど、更新に必要な情報を含める。
  - **担当ファイル:** `src/web/components/ItemForm.tsx`

- **タスク 3.2: メッセージングの実装 (Extension -> WebView)**
  - **内容:**
    - `story.yaml`の更新が完了した後、拡張機能側からWebViewに更新完了のメッセージを送信する。
    - WebView側でこのメッセージを受け取り、テーブル表示をリフレッシュして追加されたアイテムを即座に表示する。
  - **担当ファイル:** `src/web/extension.ts`, `src/web/App.tsx`

## 3. 成果物

- WebView上のUI操作による`story.yaml`への新規アイテム（Epic, Story, Task）追加機能。
- 追加後の変更がリアルタイムでWebViewに反映されること。
